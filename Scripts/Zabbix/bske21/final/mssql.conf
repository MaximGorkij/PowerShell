########################################
# mssql.custom.Monitoring – FINAL
########################################

### PING
#UserParameter=mssql.custom.ping[*],powershell -NoProfile -ExecutionPolicy Bypass -File 'C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1' "$1" "$2" "$3" "$4" "SELECT 1" numeric
UserParameter=mssql.custom.ping[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT 1' 'numeric'"


### BUFFER CACHE HIT RATIO (%)
#UserParameter=mssql.custom.cache.hit[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT CAST((SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Buffer cache hit ratio' AND instance_name='_Total') * 100.0 /  NULLIF((SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Buffer cache hit ratio base' AND instance_name='_Total'),0) AS FLOAT)" numeric
UserParameter=mssql.custom.cache.hit.ratio[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Buffer cache hit ratio'' AND instance_name=''_Total''' 'numeric'"

### BATCH REQUESTS / SEC (RAW → ZABBIX PREPROCESS DELTA)
#UserParameter=mssql.custom.batch.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Batch Requests/sec'" numeric
UserParameter=mssql.custom.batch.requests[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Batch Requests/sec''' 'numeric'"

### PAGE LIFE EXPECTANCY
#UserParameter=mssql.custom.page.life[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page life expectancy'" numeric
UserParameter=mssql.custom.page.life[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Page life expectancy''' 'numeric'"

### PAGE READS / SEC (RAW)
#UserParameter=mssql.custom.page.reads.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page reads/sec'" numeric
UserParameter=mssql.custom.page.reads[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Page reads/sec''' 'numeric'"

### PAGE WRITES / SEC (RAW)
#UserParameter=mssql.custom.page.writes.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page writes/sec'" numeric
UserParameter=mssql.custom.page.writes[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Page writes/sec''' 'numeric'"

### DEADLOCKS / SEC (RAW)
#UserParameter=mssql.custom.deadlocks.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Number of Deadlocks/sec' AND instance_name='_Total'" numeric
UserParameter=mssql.custom.deadlocks[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Number of Deadlocks/sec'' AND instance_name=''_Total''' 'numeric'"

### CONNECTIONS
#UserParameter=mssql.custom.connections[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT COUNT(*) FROM sys.dm_exec_connections" numeric
UserParameter=mssql.custom.connections[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.dm_exec_connections' 'numeric'"

### USER SESSIONS
#UserParameter=mssql.custom.sessions[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT COUNT(*) FROM sys.dm_exec_sessions WHERE is_user_process=1" numeric
UserParameter=mssql.custom.sessions[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.dm_exec_sessions WHERE is_user_process=1' 'numeric'"

### DB COUNT
#UserParameter=mssql.custom.db.count[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT COUNT(*) FROM sys.databases WHERE database_id>4" numeric
#UserParameter=mssql.custom.databases[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.databases WHERE database_id>4' 'numeric'"
UserParameter=mssql.custom.db.count[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.databases WHERE database_id>4' 'numeric'"

### DB SIZE / DB LOG SIZE
#UserParameter=mssql.custom.db.data.size[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.data_size.ps1" "$1" "$2" "$3" "$4" "$5"
UserParameter=mssql.custom.data.size[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_data_size.ps1' '$1' '$2' '$3' '$4' '$5' 'numeric'"
UserParameter=mssql.custom.db.size[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT SUM(size)*8/1024 FROM sys.master_files WHERE database_id>4' 'numeric'"

#UserParameter=mssql.custom.db.log.size[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.log_size.ps1" "$1" "$2" "$3" "$4" "$5"
UserParameter=mssql.custom.log.size[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_log_size.ps1' '$1' '$2' '$3' '$4' '$5' 'numeric'"

### DB STATE (1/0)
#UserParameter=mssql.custom.db.state[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT CASE WHEN state_desc='ONLINE' THEN 1 ELSE 0 END FROM sys.databases WHERE name='$5'" numeric
UserParameter=mssql.custom.db.state[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SET NOCOUNT ON; SELECT CASE WHEN state_desc = ''ONLINE'' THEN 1 ELSE 0 END AS state FROM sys.databases WHERE name = ''$5''' 'numeric'"
#UserParameter=mssql.custom.master.state[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.wrapper.ps1" "$1" "$2" "$3" "$4" "SET NOCOUNT ON; SELECT CASE WHEN state_desc = 'ONLINE' THEN 1 ELSE 0 END AS state FROM sys.databases WHERE name = '$5'" numeric
UserParameter=mssql.custom.master.state[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT state_desc FROM sys.databases WHERE name=''master''' 'string'"

### VERSION
#UserParameter=mssql.custom.version[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT @@VERSION" string
UserParameter=mssql.custom.version[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT @@VERSION' 'string'"

### UPTIME
#UserParameter=mssql.custom.uptime[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT DATEDIFF(SECOND,sqlserver_start_time,GETDATE()) FROM sys.dm_os_sys_info" numeric
UserParameter=mssql.custom.uptime[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT DATEDIFF(SECOND,sqlserver_start_time,GETDATE()) FROM sys.dm_os_sys_info' 'numeric'"

### LLD
#UserParameter=mssql.custom.db.discovery[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql.custom.lld.ps1" "$1" "$2" "$3" "$4"
UserParameter=mssql.custom.db.discovery[*],powershell -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_lld.ps1' '$1' '$2' '$3' '$4'"