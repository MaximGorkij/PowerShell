########################################
# MSSQL Monitoring – FINAL
########################################

### PING
UserParameter=mssql.ping[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT 1" numeric


### BUFFER CACHE HIT RATIO (%)
UserParameter=mssql.cache.hit[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT CAST((SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Buffer cache hit ratio' AND instance_name='_Total') * 100.0 /  NULLIF((SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Buffer cache hit ratio base' AND instance_name='_Total'),0) AS FLOAT)" numeric


### BATCH REQUESTS / SEC (RAW → ZABBIX PREPROCESS DELTA)
UserParameter=mssql.batch.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Batch Requests/sec'" numeric


### PAGE LIFE EXPECTANCY
UserParameter=mssql.page.life[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page life expectancy'" numeric


### PAGE READS / SEC (RAW)
UserParameter=mssql.page.reads.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page reads/sec'" numeric


### PAGE WRITES / SEC (RAW)
UserParameter=mssql.page.writes.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page writes/sec'" numeric


### DEADLOCKS / SEC (RAW)
UserParameter=mssql.deadlocks.raw[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Number of Deadlocks/sec' AND instance_name='_Total'" numeric


### CONNECTIONS
UserParameter=mssql.connections[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT COUNT(*) FROM sys.dm_exec_connections" numeric


### USER SESSIONS
UserParameter=mssql.sessions[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT COUNT(*) FROM sys.dm_exec_sessions WHERE is_user_process=1" numeric


### DB COUNT
UserParameter=mssql.db.count[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT COUNT(*) FROM sys.databases WHERE database_id>4" numeric


### DB SIZE / DB LOG SIZE
UserParameter=mssql.db.data.size[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_data_size.ps1" "$1" "$2" "$3" "$4" "$5"
UserParameter=mssql.db.log.size[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_log_size.ps1" "$1" "$2" "$3" "$4" "$5"


### DB STATE (1/0)
#UserParameter=mssql.db.state[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT CASE WHEN state_desc='ONLINE' THEN 1 ELSE 0 END FROM sys.databases WHERE name='$5'" numeric
UserParameter=mssql.db.state[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SET NOCOUNT ON; SELECT CASE WHEN state_desc = 'ONLINE' THEN 1 ELSE 0 END AS state FROM sys.databases WHERE name = '$5'" numeric

### VERSION
UserParameter=mssql.version[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT @@VERSION" string


### UPTIME
UserParameter=mssql.uptime[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" "$1" "$2" "$3" "$4" "SELECT DATEDIFF(SECOND,sqlserver_start_time,GETDATE()) FROM sys.dm_os_sys_info" numeric


### LLD
UserParameter=mssql.db.discovery[*],powershell -NoProfile -ExecutionPolicy Bypass -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_lld.ps1" "$1" "$2" "$3" "$4"
