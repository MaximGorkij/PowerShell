########################################
# MSSQL Monitoring via Powershell Wrapper
# Wrapper: mssql_wrapper.ps1
# Path: C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1
########################################

# Ping MSSQL (0/1)
UserParameter=mssql.custom.ping[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT 1' 'numeric'"

# Buffer cache hit ratio
UserParameter=mssql.custom.cache.hit.ratio[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name = ''Buffer cache hit ratio'' AND object_name LIKE ''%SQLDATA:Buffer Manager%''' 'numeric'"
#UserParameter=mssql.custom.cache.hit.ratio[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Buffer cache hit ratio'' AND instance_name=''''_Total''''' 'numeric'"

# Batch Requests/sec
UserParameter=mssql.custom.batch.requests[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Batch Requests/sec''' 'numeric'"

# Page life expectancy
UserParameter=mssql.custom.page.life[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Page life expectancy''' 'numeric'"

# Page reads/sec
UserParameter=mssql.custom.page.reads[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Page reads/sec''' 'numeric'"

# Page writes/sec
UserParameter=mssql.custom.page.writes[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Page writes/sec''' 'numeric'"

# Number of Deadlocks/sec
UserParameter=mssql.custom.deadlocks[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name=''Number of Deadlocks/sec'' AND instance_name=''_Total''' 'numeric'"

# Current connections
UserParameter=mssql.custom.connections[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.dm_exec_connections' 'numeric'"

# Active user sessions
UserParameter=mssql.custom.sessions[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.dm_exec_sessions WHERE is_user_process=1' 'numeric'"

# Number of user databases
UserParameter=mssql.custom.databases[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.databases WHERE database_id>4' 'numeric'"

# Size of user databases (MB)
#UserParameter=mssql.custom.data.size[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT SUM(size)*8/1024 FROM sys.master_files WHERE database_id>4' 'numeric'"
UserParameter=mssql.custom.data.size[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_data_size.ps1' '$1' '$2' '$3' '$4' '$5'"

# Size of logs (MB)
#UserParameter=mssql.custom.log.size[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT SUM(size)*8/1024 FROM sys.master_files WHERE type_desc=''LOG''' 'numeric'"
UserParameter=mssql.custom.log.size[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_log_size.ps1' '$1' '$2' '$3' '$4' '$5'"

# Master database state
UserParameter=mssql.custom.master.state[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT state_desc FROM sys.databases WHERE name=''master''' 'string'"

# SQL Server uptime (seconds)
UserParameter=mssql.custom.uptime[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT DATEDIFF(SECOND,sqlserver_start_time,GETDATE()) FROM sys.dm_os_sys_info' 'numeric'"

# Database count
UserParameter=mssql.custom.db.count[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT COUNT(*) FROM sys.databases WHERE database_id>4' 'numeric'"

# Total DB size (MB)
UserParameter=mssql.custom.db.size[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT SUM(size)*8/1024 FROM sys.master_files WHERE database_id>4' 'numeric'"

# DB state (TEXT)
UserParameter=mssql.custom.db.state[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT state_desc FROM sys.databases WHERE name=''$5''' 'string'"

# SQL Server version
UserParameter=mssql.custom.version[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT @@VERSION' 'string'"

# Database discovery (LLD)
#UserParameter=mssql.custom.db.discovery[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1' '$1' '$2' '$3' '$4' 'SELECT name FROM sys.databases WHERE database_id>4' 'string'"
UserParameter=mssql.custom.db.discovery[*],pwsh -NoProfile -Command "& 'C:\Program Files\Zabbix Agent 2\scripts\mssql_lld.ps1' '$1' '$2' '$3' '$4'"