########################################
# MSSQL Monitoring via Powershell Wrapper
# Wrapper: mssql_wrapper.ps1
# Path: C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1
########################################

# Buffer cache hit ratio
UserParameter=mssql.custom.cache.hit.ratio[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Buffer cache hit ratio' AND instance_name='_Total'" numeric

# Batch Requests/sec
UserParameter=mssql.custom.batch.requests[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Batch Requests/sec'" numeric

# Page life expectancy
UserParameter=mssql.custom.page.life[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page life expectancy'" numeric

# Page reads/sec
UserParameter=mssql.custom.page.reads[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page reads/sec'" numeric

# Page writes/sec
UserParameter=mssql.custom.page.writes[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Page writes/sec'" numeric

# Number of Deadlocks/sec
UserParameter=mssql.custom.deadlocks[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT cntr_value FROM sys.dm_os_performance_counters WHERE counter_name='Number of Deadlocks/sec' AND instance_name='_Total'" numeric

# Current connections
UserParameter=mssql.custom.connections[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT COUNT(*) FROM sys.dm_exec_connections" numeric

# Active user sessions
UserParameter=mssql.custom.sessions[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT COUNT(*) FROM sys.dm_exec_sessions WHERE is_user_process=1" numeric

# Number of user databases
UserParameter=mssql.custom.databases[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT COUNT(*) FROM sys.databases WHERE database_id>4" numeric

# Size of user databases (MB)
UserParameter=mssql.custom.data.size[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT SUM(size)*8/1024 FROM sys.master_files WHERE database_id>4" numeric

# Size of logs (MB)
UserParameter=mssql.custom.log.size[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT SUM(size)*8/1024 FROM sys.master_files WHERE type_desc='LOG'" numeric

# Master database state
UserParameter=mssql.custom.master.state[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT state_desc FROM sys.databases WHERE name='master'" string

# SQL Server uptime (seconds)
UserParameter=mssql.custom.uptime[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" $1 $2 $3 $4 "SET NOCOUNT ON;SELECT DATEDIFF(SECOND,sqlserver_start_time,GETDATE()) FROM sys.dm_os_sys_info" numeric

# Ping MSSQL (0/1)
UserParameter=mssql.custom.ping[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" 10.60.20.40 $1 $2 $3 "SET NOCOUNT ON;SELECT 1" numeric

# Database count
UserParameter=mssql.custom.db.count[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" 10.60.20.40 $1 $2 $3 "SET NOCOUNT ON;SELECT COUNT(*) FROM sys.databases WHERE database_id>4" numeric

# Total DB size (MB)
UserParameter=mssql.custom.db.size[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" 10.60.20.40 $1 $2 $3 "SET NOCOUNT ON;SELECT SUM(size)*8/1024 FROM sys.master_files WHERE database_id>4" numeric

# DB state (TEXT)
UserParameter=mssql.custom.db.state[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" 10.60.20.40 $1 $2 $3 $4 "SET NOCOUNT ON;SELECT state_desc FROM sys.databases WHERE name='$4'" text

# SQL Server version
UserParameter=mssql.custom.version[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" 10.60.20.40 $1 $2 $3 "SET NOCOUNT ON;SELECT @@VERSION" text

# Database discovery (LLD)
UserParameter=mssql.custom.db.discovery[*],pwsh -NoProfile -File "C:\Program Files\Zabbix Agent 2\scripts\mssql_wrapper.ps1" 10.60.20.40 $1 $2 $3 "SET NOCOUNT ON;SELECT name FROM sys.databases WHERE database_id>4" text